<!-- Panel lateral de conversaciones -->
<div class="chat-sidebar">
  <div class="chat-sidebar__header">
    <div class="chat-search">
      <svg class="chat-search__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"
        fill="currentColor">
        <path
          d="M10.68 11.74a6 6 0 0 1-7.922-8.982 6 6 0 0 1 8.982 7.922l3.04 3.04a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215ZM11.5 7a4.499 4.499 0 1 0-8.997 0A4.499 4.499 0 0 0 11.5 7Z">
        </path>
      </svg>
      <input type="text" 
             class="chat-search__input" 
             placeholder="Buscar conversaciones..."
             [value]="searchTerm()"
             (input)="onSearchChange($event)">
    </div>
    <div class="chat-filter">
      <select class="form-select form-select-sm" 
              [ngModel]="selectedFilterValue()" 
              (change)="onFilterChange($event)"
              data-cy="chat-filter">
        @for (option of filterOptions; track option.value) {
          <option [value]="option.value">{{ option.label }}</option>
        }
      </select>
    </div>
  </div>

  <div class="chat-list" data-cy="chat-list">
    <!-- Loading state -->
    @if (isLoading()) {
      <div class="chat-loading" data-cy="chat-loading">
        <p>Cargando chats...</p>
      </div>
    }

    <!-- Error state -->
    @if (showErrorState()) {
      <div class="chat-error" data-cy="chat-error">
        <div class="chat-error__content">
          <p class="chat-error__message">{{ error() }}</p>
          <button type="button" 
                  (click)="retryLoadChats()"
                  class="chat-error__retry-button gh-button gh-button--accent" 
                  data-cy="retry-button">
            <span>Reintentar</span>
            @if (isRetryLoading()) {
              <div class="gh-button__spinner spinner spinner--sm spinner--white">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                  stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M12 2v4" />
                  <path d="m16.2 7.8 2.9-2.9" />
                  <path d="M18 12h4" />
                  <path d="m16.2 16.2 2.9 2.9" />
                  <path d="M12 18v4" />
                  <path d="m4.9 19.1 2.9-2.9" />
                  <path d="M2 12h4" />
                  <path d="m4.9 4.9 2.9 2.9" />
                </svg>
              </div>
            }
          </button>
        </div>
      </div>
    }

    <!-- Empty state -->
    @if (showEmptyState()) {
      <div class="chat-empty" data-cy="chat-empty">
        <p>No hay chats disponibles.</p>
      </div>
    }

    <!-- Chat items -->
    @for (chat of filteredChats(); track chat.id; let isFirst = $first) {
      <div class="chat-item"
           [class.chat-item--active]="isFirst" 
           [attr.data-chat-id]="chat.id" 
           data-cy="chat-item">
        <div class="chat-item__avatar">
          <img [src]="getParticipantAvatarUrl(chat)" 
               [alt]="getVisitorName(chat)"
               class="chat-item__avatar-image"
               (error)="onAvatarError($event, chat)">
          <span class="chat-item__avatar-fallback">{{ getParticipantInitials(chat) }}</span>
          <span class="chat-item__status" [class]="getParticipantStatusClass(chat)" [title]="getParticipantStatusText(chat)"></span>
        </div>
        <div class="chat-item__content">
          <div class="chat-item__header">
            <h4 class="chat-item__name">{{ getVisitorName(chat) }}</h4>
            <span class="chat-item__time">{{ formatLastMessageTime(chat) }}</span>
          </div>
          <div class="chat-item__info">
            <p class="chat-item__preview">{{ getLastMessagePreview(chat) }}</p>
            @if (getVisitor(chat)?.isTyping) {
              <p class="chat-item__status-text typing">Escribiendo...</p>
            } @else if (getVisitor(chat)?.isViewing) {
              <p class="chat-item__status-text viewing">Viendo la p√°gina</p>
            } @else if (getParticipantStatusClass(chat) === 'chat-item__status--inactive') {
              <p class="chat-item__status-text inactive">Inactivo</p>
            }
          </div>
        </div>
      </div>
    }
  </div>
</div>
