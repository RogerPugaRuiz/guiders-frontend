<div class="chat-container">
	<div class="gh-page-header">
		<div>
			<h1 class="gh-page-header__title">Chat en Tiempo Real</h1>
			<p class="gh-page-header__description">Interactúa con los visitantes de tu sitio web en tiempo real.</p>
		</div>
		<div class="gh-page-header__actions">
		</div>
	</div>

	<div class="chat-workspace">
		<!-- Panel lateral de conversaciones -->
		<div class="chat-sidebar">
			<div class="chat-sidebar__header">
				<div class="chat-search">
					<svg class="chat-search__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"
						fill="currentColor">
						<path
							d="M10.68 11.74a6 6 0 0 1-7.922-8.982 6 6 0 0 1 8.982 7.922l3.04 3.04a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215ZM11.5 7a4.499 4.499 0 1 0-8.997 0A4.499 4.499 0 0 0 11.5 7Z">
						</path>
					</svg>
					<input type="text" class="chat-search__input" placeholder="Buscar conversaciones...">
				</div>
				<div class="chat-filter">
					<select class="form-select form-select-sm" [ngModel]="selectedFilterValue()" (change)="onFilterChange($event)"
						data-cy="chat-filter">
						@for (option of filterOptions; track option.value) {
							<option [value]="option.value">{{ option.label }}</option>
						}
					</select>
				</div>
			</div>

			<div class="chat-list" data-cy="chat-list">
				<!-- Loading state -->
				@if (isLoading()) {
					<div class="chat-loading" data-cy="chat-loading">
						<p>Cargando chats...</p>
					</div>
				}

				<!-- Error state -->
				@if (showErrorState()) {
					<div class="chat-error" data-cy="chat-error">
						<div class="chat-error__content">
							<p class="chat-error__message">{{ error() }}</p>
							<button type="button" (click)="retryLoadChats()"
								class="chat-error__retry-button gh-button gh-button--accent" data-cy="retry-button">
								<span>Reintentar</span>
								@if (isRetryLoading()) {
									<div class="gh-button__spinner spinner spinner--sm spinner--white">
										<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
											stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
											<path d="M12 2v4" />
											<path d="m16.2 7.8 2.9-2.9" />
											<path d="M18 12h4" />
											<path d="m16.2 16.2 2.9 2.9" />
											<path d="M12 18v4" />
											<path d="m4.9 19.1 2.9-2.9" />
											<path d="M2 12h4" />
											<path d="m4.9 4.9 2.9 2.9" />
										</svg>
									</div>
								}
							</button>
						</div>
					</div>
				}

				<!-- Empty state -->
				@if (showEmptyState()) {
					<div class="chat-empty" data-cy="chat-empty">
						<p>No hay chats disponibles.</p>
					</div>
				}

				<!-- Chat items -->
				@for (chat of filteredChats(); track chat.id; let isFirst = $first) {
					<div class="chat-item"
						[class.chat-item--active]="isFirst" [attr.data-chat-id]="chat.id" data-cy="chat-item">
						<div class="chat-item__avatar">
							<span>{{ getParticipantInitials(chat) }}</span>
							<span class="chat-item__status" [class]="getParticipantStatusClass(chat)"></span>
						</div>
						<div class="chat-item__content">
							<div class="chat-item__header">
								<h4 class="chat-item__name">{{ getVisitorName(chat) }}</h4>
								<span class="chat-item__time">{{ formatLastMessageTime(chat) }}</span>
							</div>
							<p class="chat-item__preview">{{ getLastMessagePreview(chat) }}</p>
						</div>
					</div>
				}
			</div>
		</div>

		<!-- Área principal del chat -->
		<div class="chat-main">
			<div class="chat-header">
				<div class="chat-contact">
					<div class="chat-contact__avatar">
						<span>AR</span>
						<span class="chat-contact__status chat-contact__status--online"></span>
					</div>
					<div class="chat-contact__info">
						<h3 class="chat-contact__name">Ana Rodríguez</h3>
						<p class="chat-contact__metadata">Barcelona, España • En línea</p>
					</div>
				</div>
				<div class="chat-actions">
					<button class="gh-button gh-button--icon tracking-btn" [class.active]="showTrackingPanel()"
						title="Actividad del visitante" (click)="toggleTrackingInfo()">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
							stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
							class="lucide lucide-book-text-icon lucide-book-text">
							<path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H19a1 1 0 0 1 1 1v18a1 1 0 0 1-1 1H6.5a1 1 0 0 1 0-5H20" />
							<path d="M8 11h8" />
							<path d="M8 7h6" />
						</svg>
					</button>
					<button class="gh-button gh-button--icon" title="Alertas importantes">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
							stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
							class="lucide lucide-info-icon lucide-info">
							<circle cx="12" cy="12" r="10" />
							<path d="M12 16v-4" />
							<path d="M12 8h.01" />
						</svg>
					</button>
					<button class="gh-button gh-button--icon" title="Más opciones">
						<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
							<path
								d="M8 2a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3ZM8 6.5a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3ZM9.5 12.5a1.5 1.5 0 1 0-3 0 1.5 1.5 0 0 0 3 0Z">
							</path>
						</svg>
					</button>
				</div>
			</div>

			<!-- Panel de información de tracking -->
			<div class="tracking-info-panel" #trackingInfoPanel [class.show]="showTrackingPanel()">
				<div class="tracking-info-header">
					<h4>Actividad del Visitante</h4>
					<button class="gh-button gh-button--icon close-tracking-btn" (click)="closeTrackingInfo()">
						<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
							<path
								d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l3.22 3.22a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-3.22 3.22a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06Z">
							</path>
						</svg>
					</button>
				</div>
				<div class="tracking-info-content">
					<div class="tracking-info-item">
						<strong>Página actual:</strong>
						<span>https://guiders.es/servicios/tours-barcelona</span>
					</div>
					<div class="tracking-info-item">
						<strong>Referencia:</strong>
						<span>Google Search</span>
					</div>
					<div class="tracking-info-item">
						<strong>Tiempo en página:</strong>
						<span>3m 45s</span>
					</div>
					<div class="tracking-info-item">
						<strong>Páginas visitadas:</strong>
						<ul class="tracking-pages-list">
							<li>
								<span class="page-title">Página principal</span>
								<span class="page-time">12:20</span>
							</li>
							<li>
								<span class="page-title">Tours en Barcelona</span>
								<span class="page-time">12:25</span>
							</li>
							<li>
								<span class="page-title">Tours gastronómicos</span>
								<span class="page-time">12:28</span>
							</li>
						</ul>
					</div>
					<div class="tracking-info-item">
						<strong>Dispositivo:</strong>
						<span>iPhone (iOS 16.5)</span>
					</div>
					<div class="tracking-info-item">
						<strong>Localización:</strong>
						<span>Barcelona, España</span>
					</div>
				</div>
			</div>

			<div class="chat-messages">
				<div class="start-conversation"></div>
				<div class="chat-date-separator">
					<span>Hoy</span>
				</div>

				<!-- Cliente (Ana) - Mensaje recibido, aparece a la izquierda -->
				<div class="chat-message chat-message--received">
					<div class="chat-message__content">
						<p>Hola, ¿podrían ayudarme con información sobre los servicios de guía turística?</p>
					</div>
					<span class="chat-message__time">12:30</span>
				</div>

				<!-- Tú (operador) - Mensaje enviado, aparece a la derecha -->
				<div class="chat-message chat-message--sent">
					<div class="chat-message__content">
						<p>¡Hola Ana! Claro, estaré encantado de ayudarte. ¿Qué tipo de tour estás buscando?</p>
					</div>
					<span class="chat-message__time">12:32</span>
				</div>

				<!-- Cliente (Ana) - Mensaje recibido, aparece a la izquierda -->
				<div class="chat-message chat-message--received">
					<div class="chat-message__content">
						<p>Estoy interesada en tours culturales y gastronómicos. Viajaré a Barcelona el próximo mes.</p>
					</div>
					<span class="chat-message__time">12:35</span>
				</div>

				<!-- Tú (operador) - Mensaje enviado, aparece a la derecha -->
				<div class="chat-message chat-message--sent">
					<div class="chat-message__content">
						<p>¡Genial! Barcelona tiene mucho que ofrecer en ese sentido. Tenemos tours diarios que combinan visitas a
							monumentos históricos con degustaciones de la gastronomía local. ¿Te gustaría recibir más detalles sobre
							estos tours?</p>
					</div>
					<span class="chat-message__time">12:40</span>
				</div>

				<!-- Cliente (Ana) - Mensaje recibido, aparece a la izquierda -->
				<div class="chat-message chat-message--received">
					<div class="chat-message__content">
						<p>Sí, por favor. También me gustaría saber los precios y disponibilidad para la primera semana de junio.
						</p>
					</div>
					<span class="chat-message__time">12:45</span>
				</div>

				<!-- Cliente (Ana) - Mensaje recibido, aparece a la izquierda -->
				<div class="chat-message chat-message--received">
					<div class="chat-message__content">
						<p>Sí, por favor. También me gustaría saber los precios y disponibilidad para la primera semana de junio.
						</p>
					</div>
					<span class="chat-message__time">12:45</span>
				</div>


				<!-- Cliente (Ana) - Mensaje recibido, aparece a la izquierda -->
				<div class="chat-message chat-message--received">
					<div class="chat-message__content">
						<p>Sí, por favor. También me gustaría saber los precios y disponibilidad para la primera semana de junio.
						</p>
					</div>
					<span class="chat-message__time">12:45</span>
				</div>


				<!-- Cliente (Ana) - Mensaje recibido, aparece a la izquierda -->
				<div class="chat-message chat-message--received">
					<div class="chat-message__content">
						<p>Sí, por favor. También me gustaría saber los precios y disponibilidad para la primera semana de junio.
						</p>
					</div>
					<span class="chat-message__time">12:45</span>
				</div>


				<!-- Cliente (Ana) - Mensaje recibido, aparece a la izquierda -->
				<div class="chat-message chat-message--received">
					<div class="chat-message__content">
						<p>Sí, por favor. También me gustaría saber los precios y disponibilidad para la primera semana de junio.
						</p>
					</div>
					<span class="chat-message__time">12:45</span>
				</div>


				<!-- Cliente (Ana) - Mensaje recibido, aparece a la izquierda -->
				<div class="chat-message chat-message--received">
					<div class="chat-message__content">
						<p>Sí, por favor. También me gustaría saber los precios y disponibilidad para la primera semana de junio.
						</p>
					</div>
					<span class="chat-message__time">12:45</span>
				</div>


				<!-- Cliente (Ana) - Mensaje recibido, aparece a la izquierda -->
				<div class="chat-message chat-message--received">
					<div class="chat-message__content">
						<p>Sí, por favor. También me gustaría saber los precios y disponibilidad para la primera semana de junio.
						</p>
					</div>
					<span class="chat-message__time">12:45</span>
				</div>

				<!-- Cliente (Ana) - Mensaje recibido, aparece a la izquierda -->
				<div class="chat-message chat-message--received">
					<div class="chat-message__content">
						<p>Sí, por favor. También me gustaría saber los precios y disponibilidad para la primera semana de junio.
						</p>
					</div>
					<span class="chat-message__time">12:45</span>
				</div>

				<!-- Cliente (Ana) - Mensaje recibido, aparece a la izquierda -->
				<div class="chat-message chat-message--received">
					<div class="chat-message__content">
						<p>Sí, por favor. También me gustaría saber los precios y disponibilidad para la primera semana de junio.
						</p>
					</div>
					<span class="chat-message__time">12:45</span>
				</div>
			</div>

			<div class="chat-input">
				<button class="gh-button gh-button--icon" title="Adjuntar archivo">
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
						stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
						class="lucide lucide-paperclip-icon lucide-paperclip">
						<path d="M13.234 20.252 21 12.3" />
						<path
							d="m16 6-8.414 8.586a2 2 0 0 0 0 2.828 2 2 0 0 0 2.828 0l8.414-8.586a4 4 0 0 0 0-5.656 4 4 0 0 0-5.656 0l-8.415 8.585a6 6 0 1 0 8.486 8.486" />
					</svg>
				</button>
				<textarea 
					#messageTextarea
					class="chat-input__field" 
					placeholder="Escribe tu mensaje aquí... • Pulsa Enter para enviar • Shift + Enter para nueva línea"
					rows="1"
					[value]="currentMessage()"
					(input)="onMessageInput($event)"
					(keydown)="onKeyDown($event)">
				</textarea>
				<button 
					class="gh-button gh-button--icon" 
					title="Enviar mensaje" 
					(click)="sendMessage()"
					[disabled]="!canSendMessage()">
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
						stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
						class="lucide lucide-send-horizontal-icon lucide-send-horizontal">
						<path
							d="M3.714 3.048a.498.498 0 0 0-.683.627l2.843 7.627a2 2 0 0 1 0 1.396l-2.842 7.627a.498.498 0 0 0 .682.627l18-8.5a.5.5 0 0 0 0-.904z" />
						<path d="M6 12h16" />
					</svg>
				</button>
			</div>
		</div>
	</div>
</div>