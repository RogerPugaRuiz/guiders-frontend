<div class="chat-container">
	<div class="gh-page-header">
		<div>
			<h1 class="gh-page-header__title">Chat en Tiempo Real</h1>
			<p class="gh-page-header__description">Interactúa con los visitantes de tu sitio web en tiempo real.</p>
		</div>
		<div class="gh-page-header__actions">
		</div>
	</div>

	<div class="chat-workspace">
		<!-- Panel lateral de conversaciones -->
		<app-chat-list (chatSelected)="onChatSelected($event)" (participantStatusUpdated)="onParticipantStatusUpdated($event)"></app-chat-list>
		<!-- Área principal del chat -->
		<div class="chat-main">
			<div class="chat-header">
				@if (selectedChat()) {
					<div class="chat-contact">
						<div class="chat-contact__avatar">
							<span class="chat-contact__status" [class]="selectedChatStatusClass()"></span>
							<img [src]="getChatAvatarUrl()" 
								 [alt]="visitor()"
								 class="chat-contact__avatar-image"
								 (error)="onAvatarError($event)">
							<span class="chat-contact__avatar-fallback">{{ selectedChatInitials() }}</span>
						</div>
						<div class="chat-contact__info">
							<h3 class="chat-contact__name">{{ visitor() }}</h3>
							<p class="chat-contact__metadata">{{ visitorStatus() }}</p>
						</div>
					</div>
				} @else {
					<div class="chat-contact">
						<div class="chat-contact__avatar">
							<span>?</span>
							<span class="chat-contact__status chat-contact__status--offline"></span>
						</div>
						<div class="chat-contact__info">
							<h3 class="chat-contact__name">Selecciona un chat</h3>
							<p class="chat-contact__metadata">Elige una conversación de la lista</p>
						</div>
					</div>
				}
				<div class="chat-actions">
					<button class="gh-button gh-button--icon tracking-btn" [class.active]="showTrackingPanel()"
						title="Actividad del visitante" (click)="toggleTrackingInfo()">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
							stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
							class="lucide lucide-book-text-icon lucide-book-text">
							<path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H19a1 1 0 0 1 1 1v18a1 1 0 0 1-1 1H6.5a1 1 0 0 1 0-5H20" />
							<path d="M8 11h8" />
							<path d="M8 7h6" />
						</svg>
					</button>
					<button class="gh-button gh-button--icon" title="Alertas importantes">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
							stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
							class="lucide lucide-info-icon lucide-info">
							<circle cx="12" cy="12" r="10" />
							<path d="M12 16v-4" />
							<path d="M12 8h.01" />
						</svg>
					</button>
					<button class="gh-button gh-button--icon" title="Más opciones">
						<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
							<path
								d="M8 2a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3ZM8 6.5a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3ZM9.5 12.5a1.5 1.5 0 1 0-3 0 1.5 1.5 0 0 0 3 0Z">
							</path>
						</svg>
					</button>
				</div>
			</div>

			<!-- Panel de información de tracking -->
			<div class="tracking-info-panel" #trackingInfoPanel [class.show]="showTrackingPanel()">
				<div class="tracking-info-header">
					<h4>Actividad del Visitante</h4>
					<button class="gh-button gh-button--icon close-tracking-btn" (click)="closeTrackingInfo()">
						<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
							<path
								d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l3.22 3.22a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-3.22 3.22a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06Z">
							</path>
						</svg>
					</button>
				</div>
				<div class="tracking-info-content">
					<div class="tracking-info-item">
						<strong>Página actual:</strong>
						<span>https://guiders.es/servicios/tours-barcelona</span>
					</div>
					<div class="tracking-info-item">
						<strong>Referencia:</strong>
						<span>Google Search</span>
					</div>
					<div class="tracking-info-item">
						<strong>Tiempo en página:</strong>
						<span>3m 45s</span>
					</div>
					<div class="tracking-info-item">
						<strong>Páginas visitadas:</strong>
						<ul class="tracking-pages-list">
							<li>
								<span class="page-title">Página principal</span>
								<span class="page-time">12:20</span>
							</li>
							<li>
								<span class="page-title">Tours en Barcelona</span>
								<span class="page-time">12:25</span>
							</li>
							<li>
								<span class="page-title">Tours gastronómicos</span>
								<span class="page-time">12:28</span>
							</li>
						</ul>
					</div>
					<div class="tracking-info-item">
						<strong>Dispositivo:</strong>
						<span>iPhone (iOS 16.5)</span>
					</div>
					<div class="tracking-info-item">
						<strong>Localización:</strong>
						<span>Barcelona, España</span>
					</div>
				</div>
			</div>

			<!-- Área de mensajes - Componente extraído -->
			<app-chat-messages [selectedChat]="selectedChat()"></app-chat-messages>

			@if (selectedChat()) {
				<div class="chat-input">
					<button class="gh-button gh-button--icon" title="Adjuntar archivo">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
							stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
							class="lucide lucide-paperclip-icon lucide-paperclip">
							<path d="M13.234 20.252 21 12.3" />
							<path
								d="m16 6-8.414 8.586a2 2 0 0 0 0 2.828 2 2 0 0 0 2.828 0l8.414-8.586a4 4 0 0 0 0-5.656 4 4 0 0 0-5.656 0l-8.415 8.585a6 6 0 1 0 8.486 8.486" />
						</svg>
					</button>
					<textarea 
						#messageTextarea
						class="chat-input__field" 
						placeholder="Escribe tu mensaje aquí..."
						[attr.rows]="textareaRows()"
						[value]="currentMessage()"
						(input)="onMessageInput($event)"
						(keydown)="onKeyDown($event)">
					</textarea>
					<button 
						class="gh-button gh-button--icon" 
						title="Enviar mensaje" 
						(click)="sendMessage()"
						[disabled]="!canSendMessage()">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
							stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
							class="lucide lucide-send-horizontal-icon lucide-send-horizontal">
							<path
								d="M3.714 3.048a.498.498 0 0 0-.683.627l2.843 7.627a2 2 0 0 1 0 1.396l-2.842 7.627a.498.498 0 0 0 .682.627l18-8.5a.5.5 0 0 0 0-.904z" />
							<path d="M6 12h16" />
						</svg>
					</button>
				</div>
			}
		</div>
	</div>
</div>