# Workflow para deployment de staging
name: Deploy to Staging

on:
  push:
    branches: [develop, staging]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Saltarse tests para deployment r√°pido'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20'

jobs:
  # Build y deployment directo
  build-and-deploy:
    name: Build and Deploy to Staging
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment: staging
    
    env:
      STAGING_HOST: '${{ secrets.STAGING_HOST }}'
      STAGING_USER: '${{ secrets.STAGING_USER }}'
      STAGING_DEPLOY_PATH: '/var/www/guiders-frontend-staging'
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üü¢ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: |
          npm ci --legacy-peer-deps
          cd guiders-20
          npm ci --legacy-peer-deps

      - name: üß™ Run tests (if not skipped)
        if: ${{ inputs.skip_tests != true }}
        run: |
          echo "üß™ Ejecutando tests r√°pidos..."
          cd guiders-20
          npm run test:jest -- --passWithNoTests --testTimeout=30000 || echo "‚ö†Ô∏è Tests fallaron, continuando deployment"

      - name: üèóÔ∏è Build for staging
        run: |
          echo "üèóÔ∏è Construyendo aplicaci√≥n para staging..."
          cd guiders-20
          npm run build:staging
          
          # Verificar que el build fue exitoso
          if [ ! -f "dist/guiders-20/server/server.mjs" ]; then
            echo "‚ùå Error: server.mjs no fue generado"
            echo "üìÅ Estructura del build:"
            find dist -name "*.mjs" -o -name "server*" | head -10
            exit 1
          fi
          
          echo "‚úÖ Build completado - server.mjs generado correctamente"

      - name: üì¶ Prepare deployment package
        run: |
          echo "üì¶ Preparando paquete de deployment..."
          cd guiders-20
          
          # Crear package.json simplificado para staging
          cat > package-staging.json << 'EOF'
          {
            "name": "guiders-frontend-staging",
            "version": "1.0.0",
            "main": "dist/guiders-20/server/server.mjs",
            "scripts": {
              "start": "node dist/guiders-20/server/server.mjs"
            },
            "dependencies": {
              "@angular/animations": "*",
              "@angular/common": "*",
              "@angular/core": "*",
              "@angular/platform-browser": "*",
              "@angular/platform-server": "*",
              "@angular/router": "*",
              "@angular/ssr": "*",
              "express": "*",
              "rxjs": "*",
              "tslib": "*",
              "zone.js": "*"
            }
          }
          EOF
          
          # Crear tarball
          tar czf ../staging-deploy.tar.gz dist package-staging.json
          
          cd ..
          
          # Crear configuraci√≥n de PM2 actualizada
          cat > ecosystem.staging.config.js << 'EOF'
          module.exports = {
            apps: [{
              name: 'guiders-frontend-staging',
              script: './dist/guiders-20/server/server.mjs',
              cwd: '/var/www/guiders-frontend-staging',
              instances: 1,
              exec_mode: 'cluster',
              env: {
                NODE_ENV: 'staging',
                PORT: 4001,
                DEBUG: 'app:*',
                LOG_LEVEL: 'info'
              },
              error_file: '/var/log/pm2/guiders-frontend-staging-error.log',
              out_file: '/var/log/pm2/guiders-frontend-staging-out.log',
              log_file: '/var/log/pm2/guiders-frontend-staging.log',
              time: true,
              max_memory_restart: '500M',
              node_args: '--max-old-space-size=512',
              watch: false,
              restart_delay: 4000,
              max_restarts: 10,
              min_uptime: '10s',
              kill_timeout: 5000,
              merge_logs: true,
              log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
              wait_ready: true,
              listen_timeout: 15000,
              instance_var: 'INSTANCE_ID'
            }]
          };
          EOF
          
          # Crear script de deployment
          cat > deploy-staging.sh << 'EOF'
          #!/bin/bash
          set -e
          
          echo "üöÄ Iniciando deployment de staging..."
          
          # Detener aplicaci√≥n actual
          echo "üõë Deteniendo aplicaci√≥n actual..."
          pm2 stop guiders-frontend-staging 2>/dev/null || echo "App no estaba corriendo"
          pm2 delete guiders-frontend-staging 2>/dev/null || echo "App no estaba en PM2"
          
          # Limpiar logs anteriores
          rm -f /var/log/pm2/guiders-frontend-staging*.log
          
          # Descomprimir aplicaci√≥n
          echo "üì¶ Descomprimiendo aplicaci√≥n..."
          tar xzf staging-deploy.tar.gz
          
          # Usar package.json optimizado
          mv package-staging.json package.json
          
          # Verificar archivos cr√≠ticos
          if [ ! -f "./dist/guiders-20/server/server.mjs" ]; then
            echo "‚ùå Error: server.mjs no encontrado"
            exit 1
          fi
          
          echo "‚úÖ Archivos verificados correctamente"
          
          # Iniciar con PM2
          echo "üöÄ Iniciando aplicaci√≥n..."
          pm2 start ecosystem.staging.config.js
          
          # Esperar y verificar
          echo "‚è≥ Esperando inicio de la aplicaci√≥n..."
          sleep 10
          
          # Verificar estado
          if pm2 list | grep -q "guiders-frontend-staging.*online"; then
            echo "‚úÖ Aplicaci√≥n iniciada correctamente"
            pm2 logs guiders-frontend-staging --lines 10 --nostream
          else
            echo "‚ùå Error al iniciar aplicaci√≥n"
            pm2 logs guiders-frontend-staging --lines 20 --nostream
            exit 1
          fi
          
          echo "‚úÖ Deployment completado!"
          EOF
          
          chmod +x deploy-staging.sh

      - name: üì§ Upload files to staging server
        env:
          SSH_PASSWORD: ${{ secrets.STAGING_SSH_PASSWORD }}
        run: |
          echo "üîß Configurando conexi√≥n SSH..."
          sudo apt-get update && sudo apt-get install -y sshpass
          
          # Agregar host a known_hosts
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ env.STAGING_HOST }} >> ~/.ssh/known_hosts
          
          echo "üìÅ Creando directorio de staging..."
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no \
            ${{ env.STAGING_USER }}@${{ env.STAGING_HOST }} \
            "mkdir -p ${{ env.STAGING_DEPLOY_PATH }}"
          
          echo "üì§ Subiendo archivos..."
          sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no \
            staging-deploy.tar.gz \
            ecosystem.staging.config.js \
            deploy-staging.sh \
            ${{ env.STAGING_USER }}@${{ env.STAGING_HOST }}:${{ env.STAGING_DEPLOY_PATH }}/

      - name: üöÄ Deploy application
        env:
          SSH_PASSWORD: ${{ secrets.STAGING_SSH_PASSWORD }}
        run: |
          echo "üöÄ Ejecutando deployment en el servidor..."
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no \
            ${{ env.STAGING_USER }}@${{ env.STAGING_HOST }} \
            "cd ${{ env.STAGING_DEPLOY_PATH }} && chmod +x deploy-staging.sh && ./deploy-staging.sh"

      - name: üîç Verify deployment
        env:
          SSH_PASSWORD: ${{ secrets.STAGING_SSH_PASSWORD }}
        run: |
          echo "üîç Verificando deployment..."
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no \
            ${{ env.STAGING_USER }}@${{ env.STAGING_HOST }} << 'EOF'
            
            echo "üìä Estado de PM2:"
            pm2 status
            
            echo ""
            echo "üåê Verificando puerto 4001:"
            if netstat -tulpn | grep -q :4001; then
              echo "‚úÖ Puerto 4001 est√° en uso"
            else
              echo "‚ùå Puerto 4001 no est√° en uso"
              echo "Puertos activos:"
              netstat -tulpn | grep LISTEN
            fi
            
            echo ""
            echo "üß™ Probando aplicaci√≥n:"
            if curl -f -s --max-time 10 http://localhost:4001 > /dev/null; then
              echo "‚úÖ Aplicaci√≥n responde correctamente"
            else
              echo "‚ùå Aplicaci√≥n no responde"
              echo "üìä Logs recientes:"
              pm2 logs guiders-frontend-staging --lines 10 --nostream
            fi
          EOF

      - name: üìã Deployment summary
        if: always()
        run: |
          echo "# üìä Staging Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend API:** http://217.154.105.26/api" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend Port:** 4001" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üîß Comandos √∫tiles:" >> $GITHUB_STEP_SUMMARY
          echo "```bash" >> $GITHUB_STEP_SUMMARY
          echo "# Ver logs" >> $GITHUB_STEP_SUMMARY
          echo "pm2 logs guiders-frontend-staging" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Reiniciar" >> $GITHUB_STEP_SUMMARY
          echo "pm2 restart guiders-frontend-staging" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Verificar estado" >> $GITHUB_STEP_SUMMARY
          echo "pm2 status" >> $GITHUB_STEP_SUMMARY
          echo "curl http://localhost:4001" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
