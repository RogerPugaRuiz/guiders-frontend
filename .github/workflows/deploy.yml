# Workflow para deployment de Angular SSR a producci√≥n usando GitHub Environments
# .github/workflows/deploy.yml
name: Deploy Angular SSR to Production

on:
  push:
    branches:
      - main
  workflow_dispatch: # Permite ejecutar manualmente
    inputs:
      force_deploy:
        description: 'Forzar deployment (skip some checks)'
        required: false
        default: false
        type: boolean

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: deploy
    
    env:
      NODE_VERSION: '20'
      SSH_HOST: '10.8.0.1'
      SSH_USER: 'root'
      DEPLOY_PATH: '/var/www/guiders'
      BACKUP_PATH: '/tmp/guiders-backup'

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üü¢ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üì¶ Install root dependencies
        run: npm ci --legacy-peer-deps

      - name: üì¶ Install Guiders-20 dependencies
        run: |
          cd guiders-20
          npm ci --legacy-peer-deps

      - name: üèóÔ∏è Build Angular SSR application
        run: |
          cd guiders-20
          npm run build:prod:env

      - name: üìÅ Verify build output
        run: |
          echo "Verificando estructura de build..."
          ls -la guiders-20/dist/
          
          # Verificar estructura Angular 20 (siempre tiene el subdirectorio del proyecto)
          if [ -d "guiders-20/dist/guiders-20" ]; then
            echo "‚úÖ Build exitoso - encontrado subdirectorio del proyecto"
            echo "üìÅ Contenido del build principal:"
            ls -la guiders-20/dist/guiders-20/
            
            # Verificar que existen las carpetas browser y server
            if [ -d "guiders-20/dist/guiders-20/browser" ] && [ -d "guiders-20/dist/guiders-20/server" ]; then
              echo "‚úÖ Directorios browser y server encontrados"
              
              echo "üìÅ Contenido del cliente (browser):"
              ls -la guiders-20/dist/guiders-20/browser/ | head -10
              
              echo "üìÅ Contenido del servidor (server):"
              ls -la guiders-20/dist/guiders-20/server/ | head -10
              
              # Verificar que server.mjs existe
              if [ -f "guiders-20/dist/guiders-20/server/server.mjs" ]; then
                echo "‚úÖ server.mjs encontrado"
              else
                echo "‚ùå Error: server.mjs no encontrado"
                echo "üìÅ Archivos en server/:"
                ls -la guiders-20/dist/guiders-20/server/
                exit 1
              fi
              
              # Verificar index.html en browser (puede tener diferentes nombres)
              if [ -f "guiders-20/dist/guiders-20/browser/index.csr.html" ] || [ -f "guiders-20/dist/guiders-20/browser/index.html" ]; then
                echo "‚úÖ Archivo index HTML encontrado en el cliente"
              else
                echo "‚ùå Error: No se encontr√≥ archivo index HTML en el cliente"
                echo "üìÅ Archivos HTML en browser/:"
                ls -la guiders-20/dist/guiders-20/browser/*.html 2>/dev/null || echo "No se encontraron archivos HTML"
                exit 1
              fi
            else
              echo "‚ùå Error: No se encontraron directorios browser/server"
              echo "üìÅ Contenido disponible:"
              ls -la guiders-20/dist/guiders-20/
              exit 1
            fi
          else
            echo "‚ùå Error: No se encontr√≥ el subdirectorio del proyecto en dist/"
            echo "üìÅ Explorando estructura completa:"
            find guiders-20/dist/ -type d 2>/dev/null | head -10
            echo ""
            echo "üìÅ Buscando archivos importantes:"
            find guiders-20/dist/ -name "server.mjs" -o -name "*.html" -o -name "main*.js" 2>/dev/null | head -10
            exit 1
          fi

      - name: üîí Install OpenVPN
        run: sudo apt-get update && sudo apt-get install -y openvpn sshpass

      - name: üîß Setup OpenVPN config
        run: |
          echo "${{ secrets.OVPN_CONFIG }}" > vpn.conf
          chmod 600 vpn.conf

      - name: üåê Connect to VPN
        run: |
          sudo openvpn --config vpn.conf --daemon
          sleep 20
          echo "üîç Verificando conexi√≥n VPN..."
          ping -c 3 ${{ env.SSH_HOST }} || echo "‚ö†Ô∏è Ping fall√≥, continuando..."

      - name: üîë Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -H ${{ env.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: üß™ Test SSH connection
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no ${{ env.SSH_USER }}@${{ env.SSH_HOST }} \
            "echo '‚úÖ Conexi√≥n SSH exitosa'"

      - name: üõ°Ô∏è Create backup of current deployment
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'EOF'
            # Crear backup con timestamp
            TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
            BACKUP_DIR="${{ env.BACKUP_PATH }}_${TIMESTAMP}"
            
            echo "üì¶ Creando backup en ${BACKUP_DIR}..."
            
            if [ -d "${{ env.DEPLOY_PATH }}" ]; then
              mkdir -p "${BACKUP_DIR}"
              cp -r ${{ env.DEPLOY_PATH }}/* "${BACKUP_DIR}/" || true
              echo "‚úÖ Backup creado exitosamente"
              
              # Mantener solo los √∫ltimos 5 backups
              ls -dt ${{ env.BACKUP_PATH }}_* | tail -n +6 | xargs rm -rf || true
            else
              echo "‚ö†Ô∏è No existe deployment anterior, creando directorio..."
              mkdir -p ${{ env.DEPLOY_PATH }}
            fi
          EOF

      - name: üõ†Ô∏è Prepare server environment
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'EOF'
            # Esperar un momento para evitar conflictos con actualizaciones del OS
            echo "‚è≥ Esperando estabilizaci√≥n del sistema..."
            sleep 30
            
            # Verificar/instalar Node.js si no existe
            if ! command -v node &> /dev/null; then
              echo "üì• Instalando Node.js..."
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            
            # Verificar versi√≥n de Node.js
            echo "üü¢ Node.js version: $(node --version)"
            echo "üì¶ NPM version: $(npm --version)"
            
            # Crear directorios necesarios
            mkdir -p ${{ env.DEPLOY_PATH }}/dist
            mkdir -p ${{ env.DEPLOY_PATH }}/logs
            
            # Instalar PM2 si no existe (para gesti√≥n de procesos)
            if ! command -v pm2 &> /dev/null; then
              echo "‚ö° Instalando PM2..."
              npm install -g pm2
            fi
            
            echo "üü¢ PM2 version: $(pm2 --version)"
          EOF

      - name: üöÄ Deploy Angular SSR application
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          echo "üöÄ Iniciando deployment..."
          
          # Sync del build completo (cliente + servidor)
          sshpass -p "$SSH_PASSWORD" rsync -avz --delete \
            -e "ssh -o StrictHostKeyChecking=no" \
            --progress \
            guiders-20/dist/guiders-20/ \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:${{ env.DEPLOY_PATH }}/dist/
          
          echo "‚úÖ Archivos sincronizados exitosamente"

      - name: üìã Deploy package.json and dependencies
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          # Copiar package.json y package-lock.json para las dependencias de producci√≥n
          sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no \
            guiders-20/package.json \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:${{ env.DEPLOY_PATH }}/
          
          # Copiar package-lock.json si existe
          if [ -f guiders-20/package-lock.json ]; then
            sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no \
              guiders-20/package-lock.json \
              ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:${{ env.DEPLOY_PATH }}/
            echo "‚úÖ package.json y package-lock.json copiados"
          else
            echo "‚ö†Ô∏è package-lock.json no encontrado, solo package.json copiado"
          fi

      - name: üîß Install production dependencies
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}
            echo "üì¶ Instalando dependencias de producci√≥n..."
            
            # Verificar que package.json existe
            if [ ! -f package.json ]; then
              echo "‚ùå Error: package.json no encontrado"
              exit 1
            fi
            
            # Instalar dependencias con fallback
            if [ -f package-lock.json ]; then
              npm ci --only=production --omit=dev --legacy-peer-deps
            else
              echo "‚ö†Ô∏è package-lock.json no encontrado, usando npm install"
              npm install --only=production --legacy-peer-deps
            fi
            
            echo "‚úÖ Dependencias instaladas"
          EOF

      - name: üîÑ Deploy PM2 ecosystem and management scripts
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          # Copiar archivo ecosystem.config.js predefinido al servidor
          sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no \
            .github/ecosystem.config.js \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:${{ env.DEPLOY_PATH }}/
          
          # Copiar script de gesti√≥n segura de PM2
          sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no \
            .github/pm2-safe-management.sh \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:${{ env.DEPLOY_PATH }}/
          
          echo "‚úÖ Archivos PM2 ecosystem y script de gesti√≥n copiados al servidor"

      - name: üóÑÔ∏è Deploy database cleanup scripts
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          echo "üì¶ Copiando scripts de limpieza de base de datos al servidor..."
          
          # Copiar script principal de limpieza basado en entidades
          sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no \
            clean-database-entities.sh \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:${{ env.DEPLOY_PATH }}/
          
          # Copiar script de limpieza general
          sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no \
            clean-database.sh \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:${{ env.DEPLOY_PATH }}/
          
          # Copiar documentaci√≥n y gu√≠as
          sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no \
            DATABASE-CLEANUP-README.md \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:${{ env.DEPLOY_PATH }}/
          
          sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no \
            PRODUCTION-DATABASE-CLEANUP-GUIDE.md \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:${{ env.DEPLOY_PATH }}/
          
          sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no \
            SERVIDOR-PRODUCCION-PASOS.md \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:${{ env.DEPLOY_PATH }}/
          
          sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no \
            QUICK-START-CLEANUP.md \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:${{ env.DEPLOY_PATH }}/
          
          # Hacer los scripts ejecutables en el servidor
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}
            chmod +x clean-database-entities.sh
            chmod +x clean-database.sh
            echo "‚úÖ Scripts de limpieza de base de datos configurados y ejecutables"
          EOF
          
          echo "‚úÖ Scripts de limpieza de base de datos desplegados exitosamente"

      - name: ‚ö° Start/Restart Angular SSR server (Safe PM2 Management)
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        timeout-minutes: 10
        run: |
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 -o ServerAliveInterval=10 -o ServerAliveCountMax=3 ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}
            
            echo "üîÑ Gestionando aplicaci√≥n PM2 de forma segura..."
            
            # Verificar estructura del deployment
            echo "üìÅ Verificando estructura del deployment..."
            ls -la ./dist/
            
            # Verificar que el archivo server.mjs existe
            if [ ! -f "./dist/server/server.mjs" ]; then
              echo "‚ùå Error: ./dist/server/server.mjs no encontrado"
              echo "üìÅ Contenido completo de ./dist/:"
              find ./dist/ -type f -name "*.mjs" -o -name "*.js" | head -10
              echo ""
              echo "üìÅ Buscando server.mjs en cualquier ubicaci√≥n:"
              find ./dist/ -name "server.mjs" -type f
              exit 1
            fi
            
            echo "‚úÖ server.mjs encontrado, procediendo con PM2..."
            
            # Hacer el script ejecutable
            chmod +x pm2-safe-management.sh
            
            # Reinicio simple y directo con timeouts
            echo "üîÑ Deteniendo aplicaci√≥n anterior si existe..."
            timeout 20 pm2 stop guiders-ssr 2>/dev/null || echo "‚ö†Ô∏è No hab√≠a aplicaci√≥n anterior corriendo"
            timeout 15 pm2 delete guiders-ssr 2>/dev/null || echo "‚ö†Ô∏è No hab√≠a aplicaci√≥n anterior para eliminar"
            
            echo "üöÄ Iniciando nueva aplicaci√≥n..."
            if timeout 30 pm2 start ecosystem.config.js --env production; then
              echo "‚úÖ Aplicaci√≥n iniciada con PM2"
              
              # Verificar que est√° corriendo
              sleep 5
              if timeout 10 pm2 list | grep -q "guiders-ssr.*online"; then
                echo "‚úÖ Aplicaci√≥n est√° corriendo correctamente"
                
                # Guardar configuraci√≥n
                timeout 10 pm2 save || echo "‚ö†Ô∏è No se pudo guardar la configuraci√≥n PM2"
                
                # Estado final
                echo "üìä Estado final:"
                timeout 10 pm2 status || echo "‚ö†Ô∏è No se pudo mostrar el estado"
              else
                echo "‚ùå La aplicaci√≥n no est√° corriendo despu√©s del inicio"
                timeout 10 pm2 logs guiders-ssr --lines 10 --nostream || echo "‚ö†Ô∏è No se pudieron mostrar los logs"
                exit 1
              fi
            else
              echo "‚ùå Error al iniciar la aplicaci√≥n con PM2"
              exit 1
            fi
          EOF

      # - name: üßπ Cleanup and final verification
      #   env:
      #     SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
      #   run: |
      #     # Copiar script de verificaci√≥n segura al servidor
      #     sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no \
      #       .github/verify-deployment-safe.sh \
      #       ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:${{ env.DEPLOY_PATH }}/
          
      #     # Ejecutar verificaci√≥n post-deployment segura
      #     sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'EOF'
      #       cd ${{ env.DEPLOY_PATH }}
      #       chmod +x verify-deployment-safe.sh
      #       ./verify-deployment-safe.sh
      #     EOF

      - name: üéâ Deployment Summary
        run: |
          echo "## üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ **Build**: Angular SSR aplicaci√≥n compilada" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ **Deploy**: Archivos sincronizados a servidor" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ **Dependencies**: Dependencias de producci√≥n instaladas" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ **Server**: Aplicaci√≥n SSR iniciada con PM2" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ **Database Scripts**: Scripts de limpieza de BD desplegados" >> $GITHUB_STEP_SUMMARY
          echo "- üåê **URL**: http://${{ env.SSH_HOST }}:4000" >> $GITHUB_STEP_SUMMARY
          echo "- üè∑Ô∏è **Environment**: deploy" >> $GITHUB_STEP_SUMMARY
          echo "- üìÖ **Deployed at**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- üîó **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- Verificar que la aplicaci√≥n responde correctamente" >> $GITHUB_STEP_SUMMARY
          echo "- Configurar proxy reverso (Nginx) si es necesario" >> $GITHUB_STEP_SUMMARY
          echo "- Configurar SSL/HTTPS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üóÑÔ∏è Database Management" >> $GITHUB_STEP_SUMMARY
          echo "Scripts de limpieza de base de datos disponibles en el servidor:" >> $GITHUB_STEP_SUMMARY
          echo "- \`./clean-database-entities.sh --analyze-only\` - Analizar tablas" >> $GITHUB_STEP_SUMMARY
          echo "- \`./clean-database-entities.sh\` - Limpiar base de datos" >> $GITHUB_STEP_SUMMARY
          echo "- Ver gu√≠as: \`DATABASE-CLEANUP-README.md\`, \`SERVIDOR-PRODUCCION-PASOS.md\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚ö†Ô∏è **Importante**: Crear backup antes de usar scripts de limpieza" >> $GITHUB_STEP_SUMMARY
